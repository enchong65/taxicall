<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>叫車表單</title>
  <script src="https://static.line-scdn.net/liff/edge/2/liff.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    h1 {
      text-align: center;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input, textarea, button {
      padding: 8px;
      width: 100%;
      box-sizing: border-box;
    }
    textarea {
      height: 100px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #45a049;
    }
    .error {
      color: red;
      display: none;
      margin-top: 10px;
      text-align: center;
    }
    #customForm {
      display: none; /* 初始隱藏表單，直到 LIFF 初始化完成 */
    }
  </style>
</head>
<body>
  <h1 id="formTitle">叫車表單</h1>
  <form id="customForm">
    <input type="hidden" id="userId" name="userId" value="">
    <input type="hidden" id="formType" name="formType" value="">
    <div class="form-group">
      <label for="date">日期</label>
      <input type="date" id="date" name="date" required>
    </div>
    <div class="form-group">
      <label for="time">時間</label>
      <input type="time" id="time" name="time" required>
    </div>
    <div class="form-group">
      <label for="location">地點</label>
      <input type="text" id="location" name="location" required>
    </div>
    <div class="form-group">
      <label for="numberOfPeople">人數</label>
      <input type="number" id="numberOfPeople" name="numberOfPeople" min="1" required>
    </div>
    <div class="form-group">
      <label for="phone">電話</label>
      <input type="tel" id="phone" name="phone" pattern="[0-9]{9,10}" required>
    </div>
    <div class="form-group">
      <label for="notes">備註</label>
      <textarea id="notes" name="notes"></textarea>
    </div>
    <button type="submit">提交</button>
    <p id="error" class="error"></p>
  </form>

  <script>
    // 從 URL 獲取 formType
    const urlParams = new URLSearchParams(window.location.search);
    let formType = urlParams.get('formType')?.toLowerCase();
    const validFormTypes = ['instant', 'booking'];
    const error = document.getElementById('error');
    const form = document.getElementById('customForm');

    // LIFF ID 根據 formType 設置
    const liffIds = {
      instant: '2007306335-KPmGdwnp',
      booking: '2007306335-AqY0aZm1'
    };

    // 初始化 LIFF 和表單
    window.onload = function() {
      error.style.display = 'none';

      // 驗證 formType
      if (!formType || !validFormTypes.includes(formType)) {
        error.textContent = '無效的表單類型，請透過圖文選單進入';
        error.style.display = 'block';
        form.style.display = 'none';
        return;
      }

      // 設置表單標題和 formType
      document.getElementById('formTitle').textContent = formType === 'instant' ? '即時叫車表單' : '預約叫車表單';
      document.getElementById('formType').value = formType;

      const liffId = liffIds[formType];
      if (!liffId) {
        error.textContent = '無效的 LIFF ID';
        error.style.display = 'block';
        form.style.display = 'none';
        return;
      }

      // 初始化 LIFF
      liff.init({ liffId }).then(() => {
        console.log('LIFF 初始化成功');

        // 檢查是否在 LINE 客戶端中
        if (!liff.isInClient()) {
          error.textContent = '請在 LINE 應用程式中打開此表單';
          error.style.display = 'block';
          form.style.display = 'none';
          return;
        }

        // 檢查用戶是否關注 Bot
        liff.getFriendship().then(data => {
          if (!data.friendFlag) {
            error.textContent = '請先關注我們的 LINE Bot 以繼續操作';
            error.style.display = 'block';
            liff.sendMessages([{
              type: 'text',
              text: '請點擊以下連結關注我們的 Bot：\nhttps://line.me/R/ti/p/@045xhrxld' // 替換為你的 Bot 的 LINE ID
            }]).then(() => {
              liff.openWindow({
                url: 'https://line.me/R/ti/p/@045xhrxl', // 替換為你的 Bot 的 LINE ID
                external: true
              });
            }).catch(err => {
              console.error('發送關注提示失敗: ', err);
              error.textContent = '無法發送關注提示，請手動關注我們的 LINE Bot';
              error.style.display = 'block';
            });
            return;
          }

          // 用戶已關注 Bot，獲取 userId
          if (!liff.isLoggedIn()) {
            console.log('使用者未登入，執行 liff.login()');
            error.textContent = '請先登入以繼續操作';
            error.style.display = 'block';
            liff.login({ redirectUri: window.location.href });
            return;
          }

          liff.getProfile().then(profile => {
            const userId = profile.userId;
            console.log('從 LIFF 獲取的 userId: ' + userId);
            if (!userId) {
              error.textContent = '無法獲取 UserID，請重新載入頁面';
              error.style.display = 'block';
              form.style.display = 'none';
              return;
            }
            document.getElementById('userId').value = userId;
            console.log('已將 userId 設置到表單: ' + userId);
            form.style.display = 'block'; // 初始化完成後顯示表單
          }).catch(err => {
            console.error('無法獲取使用者資訊: ', err);
            error.textContent = '無法獲取使用者資訊，請確保您已加入 LINE Bot：' + err.message;
            error.style.display = 'block';
            form.style.display = 'none';
          });
        }).catch(err => {
          console.error('無法檢查關注狀態: ', err);
          error.textContent = '無法檢查關注狀態，請確保您已加入 LINE Bot：' + err.message;
          error.style.display = 'block';
          form.style.display = 'none';
        });
      }).catch(err => {
        console.error('LIFF 初始化失敗: ', err);
        error.textContent = 'LIFF 初始化失敗，請檢查 LIFF ID 和入口 URL：' + err.message;
        error.style.display = 'block';
        form.style.display = 'none';
      });
    };

    // 表單提交
    document.getElementById('customForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      error.style.display = 'none';

      const userId = document.getElementById('userId').value;
      if (!userId) {
        error.textContent = '無法獲取 UserID，請確保您已加入 LINE Bot';
        error.style.display = 'block';
        return;
      }

      const formData = new FormData(e.target);
      console.log('提交的 FormData: ', Array.from(formData.entries()));

      try {
        // 提交表單到 Google Apps Script（僅用於寫入試算表）
        const response = await fetch('https://script.google.com/macros/s/AKfycby6-n0_Lv1BJB6KQSVVWy_q4aV-p4JsHbPkDRYnmprtgiV4sM85LRClFlLuQPSETBU1Fg/exec', {
          method: 'POST',
          body: formData,
          mode: 'cors',
          redirect: 'follow'
        });
        const result = await response.text();
        if (!response.ok) {
          throw new Error(result);
        }

        // 生成訂單摘要（前端處理）
        const formType = formData.get('formType');
        const date = formData.get('date');
        const time = formData.get('time');
        const location = formData.get('location');
        const numberOfPeople = formData.get('numberOfPeople');
        const phone = formData.get('phone');
        const notes = formData.get('notes');
        const now = new Date();
        const orderNumber = now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') +
                           String(now.getDate()).padStart(2, '0') + String(now.getHours()).padStart(2, '0') +
                           String(now.getMinutes()).padStart(2, '0') + String(now.getSeconds()).padStart(2, '0') +
                           String(now.getMilliseconds()).padStart(3, '0') + "-" + userId.slice(-4);

        const textMessage = `訂單摘要\n訂單編號: ${orderNumber}\n類型: ${formType === 'instant' ? '即時叫車' : '預約叫車'}\n-----------------------------\n日期: ${date || '未填寫'}\n時間: ${time || '未填寫'}\n地點: ${location || '未填寫'}\n人數: ${numberOfPeople || '未填寫'}\n電話: ${phone ? '0' + phone : '未填寫'}\n備註: ${notes || '未填寫'}\n`;

        // 使用 LIFF 發送訊息到當前聊天室
        await liff.sendMessages([{
          type: 'text',
          text: textMessage
        }]);
        alert('提交成功，訂單摘要已發送到聊天室');
        liff.closeWindow();
      } catch (err) {
        console.error('提交失敗: ', err);
        error.textContent = '提交失敗: ' + err.message;
        error.style.display = 'block';
      }
    });
  </script>
</body>
</html>