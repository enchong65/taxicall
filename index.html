<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>叫車表單</title>
  <script src="https://static.line-scdn.net/liff/edge/2/liff.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    h1 {
      text-align: center;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input, textarea, button {
      padding: 8px;
      width: 100%;
      box-sizing: border-box;
    }
    textarea {
      height: 100px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #45a049;
    }
    .error {
      color: red;
      display: none;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1 id="formTitle">叫車表單</h1>
  <form id="customForm">
    <input type="hidden" id="userId" name="userId" value="">
    <input type="hidden" id="formType" name="formType" value="">
    <div class="form-group">
      <label for="date">日期</label>
      <input type="date" id="date" name="date" required>
    </div>
    <div class="form-group">
      <label for="time">時間</label>
      <input type="time" id="time" name="time" required>
    </div>
    <div class="form-group">
      <label for="location">地點</label>
      <input type="text" id="location" name="location" required>
    </div>
    <div class="form-group">
      <label for="numberOfPeople">人數</label>
      <input type="number" id="numberOfPeople" name="numberOfPeople" min="1" required>
    </div>
    <div class="form-group">
      <label for="phone">電話</label>
      <input type="tel" id="phone" name="phone" pattern="[0-9]{9,10}" required>
    </div>
    <div class="form-group">
      <label for="notes">備註</label>
      <textarea id="notes" name="notes"></textarea>
    </div>
    <button type="submit">提交</button>
    <p id="error" class="error"></p>
  </form>

  <script>
    // 從 URL 獲取 formType
    const urlParams = new URLSearchParams(window.location.search);
    const formType = urlParams.get('formType')?.toLowerCase();
    const validFormTypes = ['instant', 'booking'];
    const error = document.getElementById('error');

    // LIFF ID 根據 formType 設置
    const liffIds = {
      instant: '2007299352-mGvOWvOn',
      booking: '2007299352-O3J0xJ0m'
    };

    // 動態設置表單標題和 formType
    if (!formType || !validFormTypes.includes(formType)) {
      error.textContent = '無效的表單類型，請透過圖文選單進入';
      error.style.display = 'block';
      document.getElementById('customForm').style.display = 'none';
    } else {
      document.getElementById('formTitle').textContent = formType === 'instant' ? '即時叫車表單' : '預約叫車表單';
      document.getElementById('formType').value = formType;
    }

    // 初始化 LIFF
    window.onload = function() {
      error.style.display = 'none';
      const liffId = liffIds[formType];

      if (!liffId) {
        error.textContent = '無效的 LIFF ID';
        error.style.display = 'block';
        return;
      }

      liff.init({ liffId }).then(() => {
        console.log('LIFF 初始化成功');
        if (!liff.isLoggedIn()) {
          error.textContent = '請先加入我們的 LINE Bot 以繼續操作';
          error.style.display = 'block';
          liff.login();
          return;
        }
        liff.getProfile().then(profile => {
          const userId = profile.userId;
          console.log('從 LIFF 獲取的 userId: ' + userId);
          if (!userId) {
            error.textContent = '無法獲取 UserID，請重新載入頁面';
            error.style.display = 'block';
            return;
          }
          document.getElementById('userId').value = userId;
          console.log('已將 userId 設置到表單: ' + userId);
        }).catch(err => {
          console.error('無法獲取使用者資訊: ', err);
          error.textContent = '無法獲取使用者資訊，請確保您已加入 LINE Bot：' + err.message;
          error.style.display = 'block';
        });
      }).catch(err => {
        console.error('LIFF 初始化失敗: ', err);
        error.textContent = 'LIFF 初始化失敗，請檢查 LIFF ID 和入口 URL：' + err.message;
        error.style.display = 'block';
      });
    };

    // 表單提交
    document.getElementById('customForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      error.style.display = 'none';

      const userId = document.getElementById('userId').value;
      if (!userId) {
        error.textContent = '無法獲取 UserID，請確保您已加入 LINE Bot';
        error.style.display = 'block';
        return;
      }

      const formData = new FormData(e.target);
      console.log('提交的 FormData: ', Array.from(formData.entries()));

      try {
        const response = await fetch('https://script.google.com/macros/s/AKfycbzkl6ijZmYwb_orkxlRO3pK33RoYEmgPYxqFPJWrRNVhvCzegZ8Q1ZePjHYbkyILhxLQw/exec', {
          method: 'POST',
          body: formData
        });
        const result = await response.text();
        if (response.ok) {
          alert(result);
          liff.closeWindow();
        } else {
          throw new Error(result);
        }
      } catch (err) {
        console.error('提交失敗: ', err);
        error.textContent = '提交失敗: ' + err.message;
        error.style.display = 'block';
      }
    });
  </script>
</body>
</html>